name: Build and Deploy to Cloudflare Workers

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      LC_ALL: en_US.UTF-8
      LANG: en_US.UTF-8

    steps:
    - name: ðŸ›’ Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '24'
        cache: 'npm'
        
    - name: ðŸ“‹ Install dependencies
      run: npm ci
      
    - name: ðŸ” Run linting
      run: npm run lint
      
    - name: ðŸ—ï¸ Build project (includes llms.txt generation)
      run: npm run build
      
    - name: âœ… Verify build artifacts
      run: |
        echo "ðŸ” Checking build output..."
        ls -la dist/client/
        
        echo "ðŸ“„ Verifying llms.txt exists..."
        if [ ! -f "dist/client/llms.txt" ]; then
          echo "âŒ llms.txt not found in build output"
          exit 1
        fi
        
        echo "ðŸ”¤ Checking UTF-8 encoding in llms.txt..."
        echo "First line of llms.txt:"
        head -n 1 dist/client/llms.txt
        echo "Character encoding verification:"
        file -i dist/client/llms.txt
        
        echo "ðŸ“ Verifying markdown files exist..."
        required_files=("index.html.md" "expertise.md" "work-experience.md" "education.md" "consultancy.md")
        for file in "${required_files[@]}"; do
          if [ ! -f "dist/client/$file" ]; then
            echo "âŒ $file not found in build output"
            exit 1
          fi
        done
        
        echo "ðŸ—ºï¸ Verifying sitemap.xml exists..."
        if [ ! -f "dist/client/sitemap.xml" ]; then
          echo "âŒ sitemap.xml not found in build output"
          exit 1
        fi
        
        echo "âœ… All required files verified"
        echo "ðŸ“Š Build statistics:"
        wc -c dist/client/llms.txt dist/client/*.md dist/client/sitemap.xml
        
    - name: ðŸš€ Deploy to Cloudflare Workers
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: cloudflare/wrangler-action@v3.14.1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        command: deploy --compatibility-date=2025-11-19
        
    - name: ðŸ“‹ Deployment Summary
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "## ðŸŽ‰ Deployment Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“„ Generated Files" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… llms.txt ($(wc -c < dist/client/llms.txt) bytes)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… index.html.md ($(wc -c < dist/client/index.html.md) bytes)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… expertise.md ($(wc -c < dist/client/expertise.md) bytes)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… work-experience.md ($(wc -c < dist/client/work-experience.md) bytes)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… education.md ($(wc -c < dist/client/education.md) bytes)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… consultancy.md ($(wc -c < dist/client/consultancy.md) bytes)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… sitemap.xml ($(wc -c < dist/client/sitemap.xml) bytes)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Available URLs" >> $GITHUB_STEP_SUMMARY
        echo "- [Sitemap](https://www.henriksoderlund.com/sitemap.xml)" >> $GITHUB_STEP_SUMMARY
        echo "- [llms.txt](https://www.henriksoderlund.com/llms.txt)" >> $GITHUB_STEP_SUMMARY
        echo "- [Homepage Markdown](https://www.henriksoderlund.com/index.html.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [Expertise Markdown](https://www.henriksoderlund.com/expertise.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [Work Experience Markdown](https://www.henriksoderlund.com/work-experience.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [Education Markdown](https://www.henriksoderlund.com/education.md)" >> $GITHUB_STEP_SUMMARY
        echo "- [Consultancy Markdown](https://www.henriksoderlund.com/consultancy.md)" >> $GITHUB_STEP_SUMMARY
        
  # Separate job for pull requests - build and test only, no deployment
  pr-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    env:
      LC_ALL: en_US.UTF-8
      LANG: en_US.UTF-8

    steps:
    - name: ðŸ›’ Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '24'
        cache: 'npm'
        
    - name: ðŸ“‹ Install dependencies
      run: npm ci
      
    - name: ðŸ” Run linting
      run: npm run lint
      
    - name: ðŸ—ï¸ Build and verify (PR check)
      run: |
        npm run build
        
        echo "âœ… PR build successful"
        echo "ðŸ“Š Generated file sizes:"
        wc -c dist/client/llms.txt dist/client/*.md dist/client/sitemap.xml
        
    - name: ðŸ“‹ PR Build Summary
      run: |
        echo "## ðŸ” PR Build Check Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All llms.txt files generated" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Linting passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“„ Generated Files Preview" >> $GITHUB_STEP_SUMMARY
        echo "- llms.txt: $(wc -c < dist/client/llms.txt) bytes" >> $GITHUB_STEP_SUMMARY
        echo "- sitemap.xml: $(wc -c < dist/client/sitemap.xml) bytes" >> $GITHUB_STEP_SUMMARY
        echo "- index.html.md: $(wc -c < dist/client/index.html.md) bytes" >> $GITHUB_STEP_SUMMARY
        echo "- expertise.md: $(wc -c < dist/client/expertise.md) bytes" >> $GITHUB_STEP_SUMMARY
        echo "- work-experience.md: $(wc -c < dist/client/work-experience.md) bytes" >> $GITHUB_STEP_SUMMARY
        echo "- education.md: $(wc -c < dist/client/education.md) bytes" >> $GITHUB_STEP_SUMMARY
        echo "- consultancy.md: $(wc -c < dist/client/consultancy.md) bytes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Ready for deployment once merged to main! ðŸš€" >> $GITHUB_STEP_SUMMARY